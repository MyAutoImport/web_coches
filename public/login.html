<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Acceso — Cliente</title>
<link rel="icon" href="/favicon.ico">
<style>
  :root{ --nav:#111827; --nav-b:#1f2937; --btn:#6366f1; --btn2:#334155 }
  body{background:#0f172a;color:#e5e7eb;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  /* Top bar con Inicio */
  header{display:flex;justify-content:space-between;align-items:center;background:var(--nav);border-bottom:1px solid var(--nav-b);padding:12px 16px}
  .brand{font-weight:800;letter-spacing:.2px}
  .btn{background:var(--btn2);border:0;border-radius:999px;padding:8px 12px;color:#fff;font-weight:700;cursor:pointer;text-decoration:none}
  .btn.primary{background:var(--btn)}
  /* Tarjeta login */
  .wrap{max-width:420px;margin:48px auto;padding:0 16px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  h1{margin:0 0 16px;font-size:24px}
  label{display:block;font-size:14px;margin:10px 0 6px;color:#a3a3a3}
  input{width:100%;background:#0b1220;border:1px solid #243042;border-radius:10px;padding:12px;color:#e5e7eb}
  .row{display:flex;gap:8px;margin-top:14px}
  button{flex:1;background:var(--btn);border:0;border-radius:10px;padding:12px 14px;color:#fff;font-weight:600;cursor:pointer}
  button.secondary{background:var(--btn2)}
  button:disabled{opacity:.65;cursor:wait}
  .full{width:100%;flex:unset}
  .msg{margin-top:12px;font-size:14px;color:#a3a3a3;min-height:20px}
</style>

<header>
  <span class="brand">My Auto Import</span>
  <a class="btn" href="/">Inicio</a>
</header>

<script src="/api/public-config.js"></script>
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";

  // Config pública
  const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__APP_CONFIG__ || {};
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    console.error("Faltan claves de Supabase en __APP_CONFIG__");
  }
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const form = document.querySelector("#f");
  const msg = document.querySelector("#msg");
  const btnLogin  = document.querySelector("#login");
  const btnSignup = document.querySelector("#signup");
  const btnResend = document.querySelector("#resend");
  const toHome = () => location.href = "/";

  // Si ya hay sesión → Home
  sb.auth.getSession().then(({ data }) => { if (data?.session) toHome(); });

  // Util
  const setStatus = (text) => { msg.textContent = text ?? ""; };

  // LOGIN
  btnLogin.onclick = async () => {
    setStatus("Iniciando sesión…");
    btnLogin.disabled = btnSignup.disabled = btnResend.disabled = true;

    const email = form.email.value.trim();
    const password = form.password.value;

    const { data, error } = await sb.auth.signInWithPassword({ email, password });

    if (error) {
      // Si el correo no está confirmado, sugerimos reenviar
      const t = (error.message || "").toLowerCase();
      const looksUnconfirmed =
        t.includes("confirm") || t.includes("not confirmed") || t.includes("email_not_confirmed");
      setStatus("Error: " + error.message + (looksUnconfirmed ? " · Puedes reenviar la confirmación abajo." : ""));
      if (looksUnconfirmed) btnResend.hidden = false;
      btnLogin.disabled = btnSignup.disabled = btnResend.disabled = false;
      return;
    }
    setStatus("OK. Redirigiendo…");
    toHome();
  };

  // SIGNUP
  btnSignup.onclick = async () => {
    setStatus("Creando cuenta…");
    btnLogin.disabled = btnSignup.disabled = btnResend.disabled = true;

    const email = form.email.value.trim();
    const password = form.password.value;
    const emailRedirectTo = `${location.origin}/auth-callback.html?from=client`;

    const { error } = await sb.auth.signUp({
      email,
      password,
      options: { emailRedirectTo }
    });

    setStatus(error ? ("Error: " + error.message) : "Cuenta creada. Revisa tu correo para confirmar.");
    btnLogin.disabled = btnSignup.disabled = btnResend.disabled = false;
    // mostramos el botón de reenvío por si el usuario lo necesita
    btnResend.hidden = false;
  };

  // RESEND CONFIRMATION
  btnResend.onclick = async () => {
    const email = form.email.value.trim();
    if (!email) { setStatus("Escribe tu email antes de reenviar."); return; }

    setStatus("Reenviando confirmación…");
    btnResend.disabled = true;

    try {
      const emailRedirectTo = `${location.origin}/auth-callback.html?from=client`;
      const { error } = await sb.auth.resend({
        type: "signup",
        email,
        options: { emailRedirectTo }
      });
      setStatus(error ? ("Error: " + error.message) : "Hecho. Revisa tu correo (también Spam).");
    } catch {
      setStatus("Error reenviando confirmación.");
    } finally {
      btnResend.disabled = false;
    }
  };
</script>

<div class="wrap">
  <div class="card">
    <h1>Acceso (clientes)</h1>
    <form id="f" onsubmit="return false;" autocomplete="on">
      <label for="email">Email</label>
      <input id="email" type="email" name="email" placeholder="tú@correo.com" required>

      <label for="password">Contraseña</label>
      <input id="password" type="password" name="password" placeholder="••••••••" required>

      <div class="row" aria-label="Acciones de acceso">
        <button id="login" type="button">Entrar</button>
        <button id="signup" class="secondary" type="button">Crear cuenta</button>
      </div>

      <!-- Reenviar confirmación: a ancho completo -->
      <div class="row">
        <button id="resend" class="secondary full" type="button" hidden>Reenviar confirmación</button>
      </div>

      <div class="msg" id="msg" aria-live="polite"></div>
    </form>
  </div>
</div>
