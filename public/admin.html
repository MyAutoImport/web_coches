<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Leads</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    :root{--bg:#0f172a;--panel:#111827;--panel2:#0b1220;--b:#1f2937;--muted:#9ca3af;--muted2:#a3a3a3;--accent:#6366f1}
    *{box-sizing:border-box}
    body{background:var(--bg);color:#e5e7eb;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:var(--panel);border-bottom:1px solid var(--b)}
    header h1{font-size:18px;margin:0}
    header button{background:#334155;border:0;border-radius:10px;padding:8px 12px;color:#fff;cursor:pointer}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:0 0 12px}
    .toolbar input,.toolbar select{background:var(--panel2);border:1px solid var(--b);border-radius:10px;padding:10px 12px;color:#e5e7eb}
    .toolbar button{background:var(--accent);border:0;border-radius:10px;padding:10px 12px;color:#fff;font-weight:600;cursor:pointer}
    .toolbar .ghost{background:#334155}
    #msg{margin-left:8px;color:var(--muted)}

    .stats{display:flex;gap:12px;margin:0 0 12px}
    .stat{background:var(--panel);border:1px solid var(--b);border-radius:12px;padding:12px 14px;min-width:140px}
    .stat .t{color:var(--muted2)}
    .stat .k{font-size:20px;font-weight:700}

    .pager{display:flex;gap:8px;align-items:center;margin:10px 0 14px}
    .pager button{background:#334155;border:0;border-radius:10px;padding:8px 12px;color:#fff;cursor:pointer}
    .pager button:disabled{opacity:.5;cursor:not-allowed}
    .pager .right{margin-left:auto;display:flex;align-items:center;gap:10px;color:var(--muted)}
    .pager select{background:var(--panel2);border:1px solid var(--b);border-radius:8px;color:#e5e7eb;padding:6px}

    table{width:100%;border-collapse:separate;border-spacing:0;background:var(--panel2);border:1px solid var(--b);border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid var(--b);font-size:14px;vertical-align:top}
    th{background:var(--bg);text-align:left;color:var(--muted)}
    tr:last-child td{border-bottom:0}
    a{color:#93c5fd;text-decoration:none}

    .badge{padding:2px 8px;border-radius:999px;font-size:12px;display:inline-block}
    .nuevo{background:#1f2937;color:#e5e7eb}
    .contactado{background:#065f46}

    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .btn{background:#334155;border:0;border-radius:8px;padding:6px 8px;color:#fff;cursor:pointer;font-size:12px}
    .btn.warn{background:#b91c1c}
  </style>
  <script src="/api/public-config.js"></script>
</head>
<body>
  <header>
    <h1>Panel — Leads</h1>
    <div class="actions"><button id="logout">Cerrar sesión</button></div>
  </header>

  <div class="wrap">
    <!-- FILTROS -->
    <div class="toolbar">
      <input id="q" type="search" placeholder="Buscar (nombre, email, tel, coche, mensaje)..." />
      <select id="estado">
        <option value="">Todos los estados</option>
        <option value="nuevo">Nuevo</option>
        <option value="contactado">Contactado</option>
      </select>
      <button id="apply" class="ghost">Aplicar filtros</button>
      <button id="export">Exportar CSV</button>
      <span id="msg"></span>
    </div>

    <!-- STATS -->
    <div class="stats">
      <div class="stat"><div class="t">Nuevos (hoy)</div><div class="k" id="s_today">—</div></div>
      <div class="stat"><div class="t">Esta semana</div><div class="k" id="s_week">—</div></div>
      <div class="stat"><div class="t">Total</div><div class="k" id="s_total">—</div></div>
    </div>

    <!-- PAGER -->
    <div class="pager">
      <button id="prevBtn">‹ Anterior</button>
      <span id="pageInfo" style="min-width:120px;text-align:center">Página 1</span>
      <button id="nextBtn">Siguiente ›</button>
      <div class="right">
        <span id="totalInfo">0 resultados</span>
        <label style="display:flex;align-items:center;gap:6px">
          <span>Tamaño</span>
          <select id="pageSize">
            <option>25</option>
            <option>50</option>
            <option>100</option>
          </select>
        </label>
      </div>
    </div>

    <!-- TABLA -->
    <table>
      <thead>
        <tr>
          <th style="width:160px">Fecha</th>
          <th>Nombre</th>
          <th>Email</th>
          <th>Teléfono</th>
          <th>Coche</th>
          <th>Mensaje</th>
          <th>Estado</th>
          <th style="width:180px">URL</th>
          <th style="width:230px">Acciones</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";

    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__APP_CONFIG__ || {};
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM
    const tbody    = document.getElementById("tbody");
    const msg      = document.getElementById("msg");
    const qInput   = document.getElementById("q");
    const estadoSel= document.getElementById("estado");
    const sToday   = document.getElementById("s_today");
    const sWeek    = document.getElementById("s_week");
    const sTotal   = document.getElementById("s_total");

    // Pager DOM
    const prevBtn  = document.getElementById("prevBtn");
    const nextBtn  = document.getElementById("nextBtn");
    const pageInfo = document.getElementById("pageInfo");
    const totalInfo= document.getElementById("totalInfo");
    const sizeSel  = document.getElementById("pageSize");

    // Estado de paginación
    let page = 1;
    let pageSize = Number(sizeSel.value || 25);
    let totalRows = 0;

    sizeSel.addEventListener('change', () => {
      pageSize = Number(sizeSel.value || 25);
      page = 1;
      loadLeads();
    });
    prevBtn.addEventListener('click', () => { if (page > 1) { page--; loadLeads(); }});
    nextBtn.addEventListener('click', () => {
      const maxPage = Math.max(1, Math.ceil(totalRows / pageSize));
      if (page < maxPage) { page++; loadLeads(); }
    });

    // Sesión
    async function ensureSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) location.href = "/login.html";
    }

    // Helpers de consulta (aplica filtros actuales)
    function applyFilters(qb){
      const q = qInput.value.trim();
      const est = estadoSel.value;
      if (q) qb = qb.or(`nombre.ilike.%${q}%,email.ilike.%${q}%,telefono.ilike.%${q}%,mensaje.ilike.%${q}%,coche_interes.ilike.%${q}%`);
      if (est) qb = qb.eq("estado", est);
      return qb;
    }

    // Cuentas (hoy/semana/total) — sensibles a filtros
    async function refreshCounts(){
      const now = new Date();
      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const monday = new Date(startOfDay);
      monday.setDate(startOfDay.getDate() - ((startOfDay.getDay()+6)%7)); // lunes

      // Total
      {
        let qb = supabase.from("leads").select("id", { count:"exact", head:true });
        qb = applyFilters(qb);
        const { count } = await qb;
        totalRows = count || 0;
        sTotal.textContent = totalRows;
      }
      // Hoy
      {
        let qb = supabase.from("leads").select("id", { count:"exact", head:true });
        qb = applyFilters(qb).gte("created_at", startOfDay.toISOString());
        const { count } = await qb;
        sToday.textContent = count ?? 0;
      }
      // Semana
      {
        let qb = supabase.from("leads").select("id", { count:"exact", head:true });
        qb = applyFilters(qb).gte("created_at", monday.toISOString());
        const { count } = await qb;
        sWeek.textContent = count ?? 0;
      }
    }

    // Cargar página actual
    async function loadLeads() {
      msg.textContent = "Cargando leads...";

      // 1) Refrescar contadores (actualiza totalRows)
      await refreshCounts();

      // 2) Página
      const from = (page - 1) * pageSize;
      const to   = from + pageSize - 1;

      let qb = supabase
        .from("leads")
        .select("id,created_at,nombre,email,telefono,mensaje,coche_interes,page_url,estado")
        .order("created_at", { ascending: false })
        .range(from, to);

      qb = applyFilters(qb);

      const { data, error } = await qb;
      if (error) { msg.textContent = "Error: " + error.message; return; }

      // 3) Pintar
      renderRows(data || []);
      msg.textContent = "";
      updatePager();
    }

    function updatePager(){
      const maxPage = Math.max(1, Math.ceil(totalRows / pageSize));
      pageInfo.textContent = `Página ${page} de ${maxPage}`;
      totalInfo.textContent = `${totalRows} resultados`;
      prevBtn.disabled = (page <= 1);
      nextBtn.disabled = (page >= maxPage);
    }

    function renderRows(rows) {
      tbody.innerHTML = rows.map(l => `
        <tr>
          <td>${new Date(l.created_at).toLocaleString("es-ES")}</td>
          <td>${escapeHTML(l.nombre ?? "")}</td>
          <td><a href="mailto:${l.email}">${l.email ?? ""}</a></td>
          <td><a href="tel:${l.telefono ?? ""}">${l.telefono ?? ""}</a></td>
          <td>${escapeHTML(l.coche_interes ?? "")}</td>
          <td>${escapeHTML(l.mensaje ?? "")}</td>
          <td><span class="badge ${l.estado === "contactado" ? "contactado" : "nuevo"}">${l.estado || "nuevo"}</span></td>
          <td>${l.page_url ? `<a href="${l.page_url}" target="_blank">ver</a>` : ""}</td>
          <td class="actions">
            <button class="btn" onclick="markContacted('${l.id}')">Marcar contactado</button>
            <button class="btn warn" onclick="delLead('${l.id}')">Borrar</button>
          </td>
        </tr>
      `).join("");
    }

    // Acciones
    window.markContacted = async (id) => {
      const { error } = await supabase.from("leads").update({ estado: "contactado" }).eq("id", id);
      if (error) { alert("No se pudo actualizar: " + error.message); return; }
      await loadLeads();
    };

    window.delLead = async (id) => {
      if (!confirm("¿Borrar este lead?")) return;
      const { error } = await supabase.from("leads").delete().eq("id", id);
      if (error) { alert("No se pudo borrar: " + error.message); return; }
      // si borras el último de la página, retrocede una página
      const remaining = (totalRows - 1) - (page - 1) * pageSize;
      if (remaining === 0 && page > 1) page--;
      await loadLeads();
    };

    document.getElementById("apply").onclick = () => { page = 1; loadLeads(); };
    qInput.addEventListener("keydown", (e) => { if (e.key === "Enter") { page = 1; loadLeads(); } });

    // Export CSV (todas las filas que cumplen filtros)
    document.getElementById("export").onclick = async () => {
      let qb = supabase
        .from("leads")
        .select("created_at,nombre,email,telefono,coche_interes,mensaje,estado,page_url")
        .order("created_at", { ascending: false });

      qb = applyFilters(qb).limit(5000); // sube si lo necesitas
      const { data, error } = await qb;
      if (error) { alert("No se pudo exportar: " + error.message); return; }
      const csv = toCSV(data || []);
      download("leads.csv", csv);
    };

    // Realtime — cuando entra un lead nuevo, vuelve a la primera página
    const channel = supabase.channel('realtime:leads')
      .on('postgres_changes', { event:'INSERT', schema:'public', table:'leads' }, () => {
        page = 1;
        loadLeads();
      })
      .subscribe();

    // Logout
    document.getElementById("logout").onclick = async () => {
      await supabase.auth.signOut();
      location.href = "/login.html";
    };

    // Helpers
    function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
    function toCSV(rows){
      const cols = ["created_at","nombre","email","telefono","coche_interes","mensaje","estado","page_url"];
      const head = cols.join(",");
      const body = rows.map(r => cols.map(c => csvCell(r[c])).join(",")).join("\n");
      return head + "\n" + body;
    }
    function csvCell(v){
      const s = (v ?? "").toString().replace(/"/g,'""');
      return /[",\n]/.test(s) ? `"${s}"` : s;
    }
    function download(filename, text){
      const blob = new Blob([text], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement("a"), { href:url, download:filename });
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Go!
    (async () => {
      await ensureSession();
      await loadLeads();
    })();
  </script>
</body>
</html>
