<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mi cuenta — Preferencias</title>
<link rel="icon" href="/favicon.ico">
<style>
  :root{ --nav:#111827; --nav-b:#1f2937; --btn:#6366f1; --btn2:#334155 }
  body{background:#0f172a;color:#e5e7eb;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--nav);border-bottom:1px solid var(--nav-b)}
  header h1{font-size:18px;margin:0}
  .actions-top{display:flex;gap:8px}
  .btn{background:var(--btn2);border:0;border-radius:999px;padding:8px 12px;color:#fff;font-weight:700;cursor:pointer;text-decoration:none}
  .btn.primary{background:var(--btn)}
  .wrap{max-width:900px;margin:24px auto;padding:0 16px}
  .card{background:#0b1220;border:1px solid #1f2937;border-radius:16px;padding:20px}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  label{font-size:14px;color:#a3a3a3}
  input,select,textarea{width:100%;background:#0b1220;border:1px solid #243042;border-radius:10px;padding:10px;color:#e5e7eb}
  .row{display:flex;gap:8px;align-items:center}
  .hint{color:#9ca3af;font-size:12px;margin-top:4px}
  .actions{display:flex;gap:8px;margin-top:16px}
  .save{background:var(--btn);border:0;border-radius:10px;padding:10px 14px;color:#fff;font-weight:600;cursor:pointer}
  .ok{color:#86efac;margin-left:8px}
  @media (max-width:700px){ .grid{grid-template-columns:1fr} }
</style>

<script src="/api/public-config.js"></script>
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";
  const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__APP_CONFIG__ || {};
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const msg = (t,ok=false)=>{ const e=document.getElementById("msg"); e.textContent=t; e.className = ok ? "ok" : ""; };

  // Auth gate
  const { data:{ session } } = await sb.auth.getSession();
  if (!session) location.replace("/cliente-login.html");

  // Carga inicial
  async function load(){
    const { data, error } = await sb
      .from("buyer_prefs")
      .select("*")
      .eq("user_id", session.user.id)
      .maybeSingle();
    if (error) { msg("Error cargando: "+error.message); return; }
    if (data) fill(data);
  }

  function fill(p){
    f.name.value       = p.name ?? "";
    f.phone.value      = p.phone ?? "";
    f.budget_min.value = p.budget_min ?? "";
    f.budget_max.value = p.budget_max ?? "";
    f.brands.value     = (p.brands ?? []).join(", ");
    f.models.value     = (p.models ?? []).join(", ");
    f.fuel.value       = (p.fuel ?? []).join(", ");
    f.gearbox.value    = (p.gearbox ?? []).join(", ");
    f.body.value       = (p.body ?? []).join(", ");
    f.year_min.value   = p.year_min ?? "";
    f.year_max.value   = p.year_max ?? "";
    f.km_max.value     = p.km_max ?? "";
    f.notify.checked   = p.notify_email ?? true;
  }

  const csvToArray = s => (s||"").split(",").map(x=>x.trim()).filter(Boolean);

  async function save(){
    msg("Guardando…");
    const payload = {
      user_id: session.user.id,
      name: f.name.value.trim() || null,
      phone: f.phone.value.trim() || null,
      budget_min: +f.budget_min.value || null,
      budget_max: +f.budget_max.value || null,
      brands: csvToArray(f.brands.value) || null,
      models: csvToArray(f.models.value) || null,
      fuel: csvToArray(f.fuel.value) || null,
      gearbox: csvToArray(f.gearbox.value) || null,
      body: csvToArray(f.body.value) || null,
      year_min: +f.year_min.value || null,
      year_max: +f.year_max.value || null,
      km_max: +f.km_max.value || null,
      notify_email: !!f.notify.checked
    };

    const { error } = await sb.from("buyer_prefs").upsert(payload, { onConflict:"user_id" });
    if (error) { msg("Error guardando: "+error.message); return; }
    msg("Preferencias guardadas", true);
  }

  document.getElementById("logout").onclick = async () => {
    await sb.auth.signOut(); location.href="/cliente-login.html";
  };
  document.getElementById("save").onclick = save;

  await load();
</script>

<header>
  <h1>Mi cuenta — Preferencias</h1>
  <div class="actions-top">
    <a class="btn" href="/">Inicio</a>
    <button id="logout" class="btn primary">Cerrar sesión</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <form id="f" onsubmit="return false;">
      <div class="grid">
        <div>
          <label>Nombre</label>
          <input name="name" placeholder="Tu nombre">
        </div>
        <div>
          <label>Teléfono</label>
          <input name="phone" placeholder="Opcional">
        </div>

        <div>
          <label>Presupuesto mínimo (€)</label>
          <input name="budget_min" inputmode="numeric" placeholder="Ej. 15000">
        </div>
        <div>
          <label>Presupuesto máximo (€)</label>
          <input name="budget_max" inputmode="numeric" placeholder="Ej. 30000">
        </div>

        <div>
          <label>Marcas (coma separadas)</label>
          <input name="brands" placeholder="BMW, Audi, Mercedes">
          <div class="hint">Déjalo vacío para cualquiera</div>
        </div>
        <div>
          <label>Modelos (coma separadas)</label>
          <input name="models" placeholder="M4, A3, Clase C">
        </div>

        <div>
          <label>Combustible (coma separadas)</label>
          <input name="fuel" placeholder="gasolina, diesel, hibrido, electrico">
        </div>
        <div>
          <label>Cambio (coma separadas)</label>
          <input name="gearbox" placeholder="manual, automatico">
        </div>

        <div>
          <label>Carrocería (coma separadas)</label>
          <input name="body" placeholder="suv, coupe, berlina, familiar...">
        </div>
        <div class="row" style="gap:12px">
          <div style="flex:1">
            <label>Año mínimo</label>
            <input name="year_min" inputmode="numeric" placeholder="2016">
          </div>
          <div style="flex:1">
            <label>Año máximo</label>
            <input name="year_max" inputmode="numeric" placeholder="2023">
          </div>
        </div>

        <div>
          <label>Kilometraje máx.</label>
          <input name="km_max" inputmode="numeric" placeholder="120000">
        </div>
        <div class="row">
          <input id="notify" type="checkbox" checked>
          <label for="notify">Recibir avisos por email</label>
        </div>
      </div>

      <div class="actions">
        <button id="save" class="save">Guardar preferencias</button>
        <span id="msg"></span>
      </div>
    </form>
  </div>
</div>
	