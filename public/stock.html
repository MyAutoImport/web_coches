<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stock de vehículos — My Auto Import</title>
  <meta name="description" content="Explora nuestro catálogo de coches disponibles: filtra por marca, combustible, año, precio y ordena por los criterios que prefieras.">
  <meta name="robots" content="index,follow">
  <link id="canonical" rel="canonical" href="https://myautoimport.es/stock.html">

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="My Auto Import">
  <meta property="og:title" content="Stock de vehículos — My Auto Import">
  <meta property="og:description" content="Filtra y descubre nuestros coches disponibles.">
  <meta property="og:image" id="og-image" content="https://myautoimport.es/og-image.jpg">
  <meta property="og:url" id="og-url" content="https://myautoimport.es/stock.html">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="MyAutoImport — Coches Premium Importados">
  <meta name="twitter:description" content="Vehículos verificados, importación rápida y garantía europea.">
  <meta name="twitter:image" id="twitter-image" content="https://myautoimport.es/og-image.jpg">

  <!-- Favicons / PWA -->
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/favicon.ico" sizes="any">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest?v=2">
  <meta name="theme-color" content="#0f172a">

  <!-- Config + Auth (sin defer para que exista __APP_CONFIG__) -->
  <script src="/api/public-config.js"></script>
  <script type="module" src="/js/auth-widget.js"></script>

  <!-- Canonical/OG dinámico -->
  <script>
    (function () {
      const cfg = window.__APP_CONFIG__ || {};
      const site = (cfg.SITE_ORIGIN || location.origin).replace(/\/$/, "");
      document.getElementById('canonical')?.setAttribute('href', `${site}/stock.html`);
      document.getElementById('og-url')?.setAttribute('content', `${site}/stock.html`);
      const ogImg = document.getElementById('og-image');
      if (ogImg) ogImg.setAttribute('content', `${site}/og-image.jpg`);
      const twImg = document.getElementById('twitter-image') || document.querySelector('meta[name="twitter:image"]');
      if (twImg) twImg.setAttribute('content', `${site}/og-image.jpg`);
    })();
  </script>

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="/css/main.css">

  <!-- Utils -->
  <script src="/js/utils.js" defer></script>

  <!-- Cloudflare Web Analytics -->
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token":"6bacc6c3cd2f482793c643c5fe8df0b7"}'></script>
</head>
<body>
  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="nav-wrap">
      <a class="brand" href="/" aria-label="Inicio">My Auto Import</a>
      <button id="nav-toggle" class="nav-toggle" aria-label="Abrir menú" aria-controls="mobile-drawer" aria-expanded="false">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
      </button>
      <nav class="nav-desktop" aria-label="Menú principal">
        <a href="/#servicios">Servicios</a>
        <a href="/stock.html">Stock</a>
        <div id="user-nav" class="user-nav"></div>
        <a href="/#contacto" class="btn primary">Contacto</a>
      </nav>
    </div>

    <!-- Drawer -->
    <div id="mobile-drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menú">
      <div class="drawer-inner">
        <div class="drawer-top">
          <span class="drawer-title">Menú</span>
          <button class="drawer-close" aria-label="Cerrar menú">✕</button>
        </div>
        <nav class="drawer-nav" aria-label="Navegación móvil">
          <a href="/#servicios" class="drawer-link">Servicios</a>
          <a href="/stock.html" class="drawer-link">Stock</a>
          <a href="/#contacto" class="drawer-link btn primary" style="text-align:center;">Contacto</a>
        </nav>
        <div id="user-nav-mobile" class="drawer-user" aria-label="Estado de sesión"></div>
        <div style="height:calc(12px + env(safe-area-inset-bottom,0px))"></div>
      </div>
      <button class="drawer-backdrop" tabindex="-1" aria-hidden="true"></button>
    </div>
  </header>

  <main>
    <h1>Stock de vehículos</h1>

    <!-- Filtros -->
    <section class="filters" aria-label="Filtros de búsqueda">
      <form id="filters-form">
        <div class="col-4">
          <label for="q">Buscar</label>
          <input id="q" name="q" type="search" placeholder="marca, modelo, versión…">
        </div>
        <div class="col-2">
          <label for="combustible">Combustible</label>
          <select id="combustible" name="combustible">
            <option value="">Todos</option>
            <option>Gasolina</option>
            <option>Diésel</option>
            <option>Híbrido</option>
            <option>Eléctrico</option>
          </select>
        </div>
        <div class="col-2">
          <label for="caja">Caja</label>
          <select id="caja" name="caja">
            <option value="">Todas</option>
            <option>Manual</option>
            <option>Automático</option>
          </select>
        </div>
        <div class="col-2">
          <label for="anio_min">Año mín.</label>
          <input id="anio_min" name="anio_min" type="number" inputmode="numeric" min="1980" placeholder="2015">
        </div>
        <div class="col-2">
          <label for="anio_max">Año máx.</label>
          <input id="anio_max" name="anio_max" type="number" inputmode="numeric" min="1980" placeholder="2025">
        </div>
        <div class="col-2">
          <label for="precio_max">Precio máx. (€)</label>
          <input id="precio_max" name="precio_max" type="number" inputmode="numeric" step="500" placeholder="50000">
        </div>
        <div class="col-3">
          <label for="orden">Ordenar por</label>
          <select id="orden" name="orden">
            <option value="created_at.desc">Novedades</option>
            <option value="precio_objetivo.asc">Precio ↑</option>
            <option value="precio_objetivo.desc">Precio ↓</option>
            <option value="anio.desc">Año ↓</option>
            <option value="km.asc">KM ↑</option>
            <option value="km.desc">KM ↓</option>
          </select>
        </div>
        <div class="actions">
          <button type="submit" class="btn primary">Aplicar</button>
          <button type="button" id="reset" class="btn" style="background:#0B1220;border:1px solid var(--border);color:#fff">Reset</button>
        </div>
      </form>
    </section>

    <!-- Resultados -->
    <section aria-live="polite">
      <div class="grid" id="results"></div>
      <div class="pager">
        <button id="prev">Anterior</button>
        <span id="pageinfo" style="color:var(--muted)"></span>
        <button id="next">Siguiente</button>
      </div>
    </section>
  </main>

  <!-- App de stock -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // Espera defensiva a la config
    const waitForConfig = async (ms=3000) => {
      const t0 = performance.now();
      while (!window.__APP_CONFIG__ && performance.now()-t0 < ms) {
        await new Promise(r=>setTimeout(r,50));
      }
      return window.__APP_CONFIG__;
    };
    const cfg = await waitForConfig();
    if (!cfg?.SUPABASE_URL || !cfg?.SUPABASE_ANON_KEY) {
      console.error("Falta configuración pública de Supabase");
      document.getElementById('results').innerHTML =
        '<p style="color:#FCA5A5">Error de configuración.</p>';
      throw new Error("Missing __APP_CONFIG__");
    }

    const { SUPABASE_URL, SUPABASE_ANON_KEY } = cfg;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = s => document.querySelector(s);
    const results = $("#results");
    const form = $("#filters-form");
    const prevBtn = $("#prev");
    const nextBtn = $("#next");
    const pageInfo = $("#pageinfo");

    const PAGE = 12;
    const FALLBACK = "/img/fallback_car.jpg";
    let currentPage = 1;
    let total = 0;

    const sanitizeHTML = s => (s ?? '').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    function readParams(){
      const p = new URLSearchParams(location.search);
      const obj = {
        q: p.get("q") || "",
        combustible: p.get("combustible") || "",
        caja: p.get("caja") || "",
        anio_min: p.get("anio_min") || "",
        anio_max: p.get("anio_max") || "",
        precio_max: p.get("precio_max") || "",
        orden: p.get("orden") || "created_at.desc",
        page: Number(p.get("page") || "1")
      };
      Object.entries(obj).forEach(([k,v])=>{
        const el = form.querySelector(`[name="${k}"]`);
        if(el) el.value = v;
      });
      return obj;
    }

    function writeParams(obj){
      const p = new URLSearchParams();
      Object.entries(obj).forEach(([k,v])=>{ if(v) p.set(k,String(v)) });
      history.replaceState(null,"",`?${p.toString()}`);
    }

    function cardHTML(c){
      const titulo = `${c.marca ?? ""} ${c.modelo ?? ""} ${c.anio ?? ""}`.trim();
      const imgSrc = c.cover || (Array.isArray(c.imagenes) && c.imagenes[0]) || FALLBACK;
      const km = c.km != null ? `${Number(c.km).toLocaleString("es-ES")} km` : "";
      const resumen = [km, c.combustible, c.caja].filter(Boolean).join(" · ");
      const precio = c.precio_objetivo != null ? `${Number(c.precio_objetivo).toLocaleString("es-ES")} €` : "Bajo pedido";
      return `
        <article class="card">
          <a href="/car.html?id=${encodeURIComponent(c.id)}" aria-label="Ver ${sanitizeHTML(titulo)}">
            <img src="${imgSrc}" referrerpolicy="no-referrer"
                 onerror="this.onerror=null;this.src='${FALLBACK}'"
                 alt="${sanitizeHTML(titulo)}" loading="lazy" decoding="async" width="400" height="260">
          </a>
          <div>
            <div class="title">${sanitizeHTML(titulo)}</div>
            <div class="muted">${sanitizeHTML(resumen)}</div>
            <div class="muted" style="margin-top:4px">${sanitizeHTML(precio)}</div>
          </div>
        </article>`;
    }

    // Builder común de consulta con filtros
    const applyFilters = (q, params) => {
      if(params.q){
        const like = `%${params.q}%`;
        q = q.or(`marca.ilike.${like},modelo.ilike.${like},version.ilike.${like}`);
      }
      if(params.combustible) q = q.eq("combustible", params.combustible);
      if(params.caja) q = q.eq("caja", params.caja);
      if(params.anio_min) q = q.gte("anio", Number(params.anio_min));
      if(params.anio_max) q = q.lte("anio", Number(params.anio_max));
      if(params.precio_max) q = q.lte("precio_objetivo", Number(params.precio_max));

      // Orden
      const [field, dir] = (params.orden || "created_at.desc").split(".");
      q = q.order(field, { ascending: dir !== "desc", nullsFirst:false });

      // Publicación (permite null)
      q = q.or('estado_publicacion.eq.publicado,estado_publicacion.eq.disponible,estado_publicacion.is.null');
      return q;
    };

    async function fetchFrom(source, select, params){
      const from = (currentPage-1)*PAGE;
      const to = from + PAGE - 1;
      let q = supabase.from(source).select(select, { count: "exact" });
      q = applyFilters(q, params);
      return q.range(from, to);
    }

    async function fetchData(){
      const params = readParams();
      currentPage = Math.max(1, Number(params.page) || 1);
      results.innerHTML = `<p style="color:var(--muted)">Cargando resultados…</p>`;

      // 1) Intentar vista con cover
      let data, error, count;
      ({ data, error, count } = await fetchFrom(
        "cars_with_cover",
        "id, marca, modelo, anio, km, combustible, caja, imagenes, cover, precio_objetivo, created_at, estado_publicacion",
        params
      ));

      // 2) Si falla (vista no existe o columnas distintas), fallback a tabla cars
      if (error) {
        console.warn("[stock] fallo en cars_with_cover → intento cars:", error.message || error);
        ({ data, error, count } = await fetchFrom(
          "cars",
          "id, marca, modelo, anio, km, combustible, caja, imagenes, precio_objetivo, created_at, estado_publicacion",
          params
        ));
      }

      if(error){
        console.error("[stock] error final:", error);
        results.innerHTML = `<p style="color:#FCA5A5">Error cargando el stock.</p>`;
        pageInfo.textContent = "";
        prevBtn.disabled = nextBtn.disabled = true;
        return;
      }

      total = count ?? 0;
      results.innerHTML = (data && data.length)
        ? data.map(cardHTML).join("")
        : `<p style="color:var(--muted)">No hay resultados con estos filtros.</p>`;

      const totalPages = Math.max(1, Math.ceil(total / PAGE));
      pageInfo.textContent = `${currentPage} / ${totalPages}`;
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
    }

    form.addEventListener("submit", (e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      const params = Object.fromEntries(fd.entries());
      params.page = "1";
      writeParams(params);
      fetchData();
    });

    document.getElementById("reset").addEventListener("click", ()=>{
      form.reset();
      writeParams({ orden:"created_at.desc", page:"1" });
      fetchData();
    });

    document.getElementById("prev").addEventListener("click", ()=>{
      const p = readParams(); p.page = String(Math.max(1, (Number(p.page)||1)-1));
      writeParams(p); fetchData();
    });
    document.getElementById("next").addEventListener("click", ()=>{
      const p = readParams(); p.page = String((Number(p.page)||1)+1);
      writeParams(p); fetchData();
    });

    // Inicial
    fetchData();

    /* Drawer móvil + accesibilidad */
    (() => {
      const toggleBtn = document.getElementById('nav-toggle');
      const drawer    = document.getElementById('mobile-drawer');
      const closeBtn  = drawer?.querySelector('.drawer-close');
      if (!toggleBtn || !drawer) return;

      const focusableSel = ['a[href]','button:not([disabled])','input','select','textarea','[tabindex]:not([tabindex="-1"])'].join(',');
      let lastFocused = null;

      const open = () => {
        lastFocused = document.activeElement;
        drawer.classList.add('open');
        document.body.classList.add('nav-open');
        toggleBtn.setAttribute('aria-expanded','true');
        drawer.querySelector(focusableSel)?.focus({preventScroll:true});
      };
      const close = () => {
        drawer.classList.remove('open');
        document.body.classList.remove('nav-open');
        toggleBtn.setAttribute('aria-expanded','false');
        lastFocused?.focus?.({preventScroll:true});
      };
      const isOpen = () => drawer.classList.contains('open');

      toggleBtn.addEventListener('click', () => isOpen() ? close() : open(), { passive:true });
      closeBtn?.addEventListener('click', close, { passive:true });

      const reset = () => { drawer.classList.remove('open'); document.body.classList.remove('nav-open'); toggleBtn.setAttribute('aria-expanded','false'); };
      window.addEventListener('pageshow', reset);
      window.addEventListener('pagehide', reset);
      window.addEventListener('beforeunload', reset);
      document.addEventListener('visibilitychange', ()=>{ if(document.hidden) reset(); });
    })();
  </script>
</body>
</html>
