<!doctype html>
<meta charset="utf-8">
<title>Confirmación — My Auto Import</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="/api/public-config.js"></script>
<body style="background:#0f172a;color:#e5e7eb;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0">
  <div id="box" style="max-width:520px;margin:64px auto;padding:24px;background:#111827;border:1px solid #1f2937;border-radius:16px">
    Procesando…
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__APP_CONFIG__ || {};
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const q   = new URLSearchParams(location.search);
    const h   = new URLSearchParams(location.hash.slice(1));
    const box = document.getElementById("box");

    // 0) Errores de Supabase en query o hash
    {
      const err = q.get("error_description") || h.get("error_description");
      if (err) {
        alert(decodeURIComponent(err));
        const from = q.get("from");
        location.replace(from === "client" ? "/login.html" : "/leads-admin.html");
      }
    }

    // Helpers
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // Destino final según el origen y rol
    async function getDestination(session, fromParam) {
      // Login/registro desde el flujo de cliente -> HOME
      if (fromParam === "client") return "/";

      // Flujo marcado como admin: comprobamos el perfil
      if (fromParam === "admin") {
        try {
          const { data: prof } = await sb
            .from("profiles")
            .select("is_admin")
            .eq("id", session.user.id)
            .single();
          return prof?.is_admin ? "/admin.html" : "/";
        } catch {
          return "/";
        }
      }

      // Sin 'from': por defecto HOME; admins siguen a /admin.html
      try {
        const { data: prof } = await sb
          .from("profiles")
          .select("is_admin")
          .eq("id", session.user.id)
          .single();
        return prof?.is_admin ? "/admin.html" : "/";
      } catch {
        return "/";
      }
    }

    // 1) Flujo OTP manual (fallback)
    if (q.get("flow") === "otp") {
      const email = q.get("email");
      const token = q.get("token") || q.get("token_hash"); // por si acaso
      const type  = q.get("type") || "signup"; // signup | magiclink
      const from  = q.get("from");

      box.innerHTML = `
        <h1 style="margin:0 0 12px;font-size:22px">Confirmar email</h1>
        <p>Haz clic en el botón para terminar el acceso de <b>${email ?? ""}</b>.</p>
        <button id="confirm" style="background:#6366f1;border:0;border-radius:10px;padding:10px 14px;color:#fff;font-weight:600;cursor:pointer">Confirmar</button>
        <div id="msg" style="margin-top:12px;color:#9ca3af"></div>
      `;

      document.getElementById("confirm").onclick = async () => {
        const msg = document.getElementById("msg");
        msg.textContent = "Confirmando…";
        try {
          const { data, error } = await sb.auth.verifyOtp({ email, token, type });
          if (error) { msg.textContent = "Error: " + error.message; return; }
          // Espera breve por si la sesión tarda en hidratarse
          let session = null;
          for (let i=0;i<6;i++){ const r = await sb.auth.getSession(); session = r.data.session; if (session) break; await sleep(250); }
          if (!session) { msg.textContent = "No se pudo obtener la sesión. Vuelve a iniciar sesión."; return; }
          const dest = await getDestination(session, from);
          location.replace(dest);
        } catch (e) {
          msg.textContent = "Error: " + (e?.message || e);
        }
      };
    } else {
      // 2) Flujo estándar (enlace con hash)
      const from = q.get("from"); // 'client' | 'admin' | null

      box.textContent = "Verificando sesión…";
      let session = null;
      for (let i=0;i<8;i++){ // reintenta hasta ~2s
        const { data } = await sb.auth.getSession();
        session = data?.session;
        if (session) break;
        await sleep(250);
      }

      if (!session) {
        // no hay sesión → a login correspondiente según 'from'
        location.replace(from === "client" ? "/login.html" : "/leads-admin.html");
      } else {
        const dest = await getDestination(session, from);
        location.replace(dest);
      }
    }
  </script>
</body>
